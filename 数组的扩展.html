<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>
	<script type="text/javascript">
	Array.prototype.indexOf = function(item, index) {
		var n = this.length, i = ~~index;
		if(i < 0) {
			i += n; 
		}
		for(; i < n; i++) {
			if(this[i] === item) {
				return i;
			}
		}
		return -1;
	}

	Array.prototype.lastIndexOf = function(item, index) {
		var n = this.length, i = index == null ? n - 1 : index;
		if (i < 0) {
			i = Math.max(0, n + i);
		}
		for(; i >= 0; i--) {
			if(this[i] === item) {
				return i;
			}
		}
		return -1;
	}

	function iterator(vars, body, ret) {
		var fun = 'for(var ' + vars + 'i=0,n=this.length;i<n;i++){' +
				body.replace('_', '((i in this) && fn.call(scope, this[i], i, this))')
				+ '}' + ret;
		return Function('fn, scope', fun);
	}

	Array.prototype.forEach = iterator('', '_', '');
	console.log(Array.prototype.forEach);

	Array.prototype.filter = iterator('r=[],j=0,', 'if(_)r[j++]=this[i]', 'return r');
	Array.prototype.filter = function(fn, scope) {
		for (var r = [], j = 0, i = 0, n = this.length; i < n; i++) {
		    var tmp = fn.call(scope, this[i], i, this);
		    if (((i in this) && tmp)) 
		    	r[j++] = this[i];
		}
		return r;
	}
	console.log(Array.prototype.filter);

	Array.prototype.map = iterator('r=[],', 'r[i]=_', 'return r');

	Array.prototype.some = iterator('', 'if(_)return true', 'return false');

	Array.prototype.every = iterator('', 'if(!_)return false', 'return true');

	Array.prototype.reduce = function(fn, lastResult, scope) {
		if(this.length == 0) {
			return lastResult;
		}
		var i = lastResult !== undefined ? 0 : 1;
		var result = lastResult !== undefined ? lastResult : this[0];
		for(var n = this.length; i < n; i++) {
			result = fn.call(scope, result, this[i], i, this);
		}
		return result;
	}

	Array.prototype.reduceRight = function(fn, lastResult, scope) {
		var array = this.concat().reverse();
		return array.reduce(fn, lastResult, scope);
	}

	function contains(target, item) {
		return target.indexOf(item) > -1;
	}

	function removeAt(target, index) {
		return !!target.splice(index, 1).length;
	}

	function remove(target, item) {
		var index = target.indexOf(item);
		console.log(~index);
		if(~index) {
			return removeAt(target, index);
		}
		return false;
	}

	function shuffle(target) {
		var j, x, i = target.length;
		do{
			j = parseInt(Math.random() * i);
			x = target[--i];
			target[i] = target[j];
			target[j] = x;
		}while(i > 0);

		// for(; i > 0; j = parseInt(Math.random() * i),
			// x = target[--i], target[i] = target[j], target[j] = x){}
		return target;
	}

	function random(target) {
		return target[Math.floor(Math.random() * target.length)];
	}

	function flatten(target) {
		var result = [];
		target.forEach(function(item) {
			if(Array.isArray(item)) {
				result = result.concat(flatten(item));
			} else {
				result.push(item);
			}
		});
		return result;
	}

	function unique(target) {
		var result = [];
		loop: 
		for(var i = 0, n = target.length; i < n; i++) {
			for(var x = i + 1; x < n; x++) {
				if(target[x] == target[i]) {
					continue loop;
				}
			}
			result.push(target[i]);	
		}
		return result;
	}

	function unique2(target) {
		var temp;
		target.forEach(function(item, i, arr) {
			while(arr.indexOf(item) != (temp = arr.lastIndexOf(item))){
				target.splice(temp, 1);
			}
		});
		return target;
	}

	function compact(target) {
		return target.filter(function(el) {
			return el != null;
		});
	}

	function pluck(target, name) {
		var result = [], prop;
		target.forEach(function(item) {
			prop = item[name];
			if(prop != null) {
				result.push(prop);
			}
		});
		return result;
	}

	function groupBy(target, val) {
		var result = {};
		var iterator = $.isFunction(val) ? val : function(obj) {
			return obj[val];
		};
		target.forEach(function(value, index) {
			var key = iterator(value, index);
			(result[key] || (result[key] = []).push(value));
		});
		return result;
	}

	function groupBy2(target, val) {
		var result = {};
		target.forEach(function(value, index) {
			var key = value[val];
			var tmp = result[key] || (result[key] = []);
			tmp.push(value);
		});
		return result;
	}

	function sortBy(target, fn, scope) {
		var array = target.map(function(item, index) {
			return {
				el: item,
				re: fn.call(scope, item, index)
			};
		}).sort(function(left, right) {
			var a = left.re, b = right.re;
			return a < b ? -1 : a > b ? 1 : 0;
		});
		return pluck(array, 'el');
	}

	function union(target, array) {
		return unique(target.concat(array));
	}

	function intersect(target, array) {
		return target.filter(function(n) {
			console.log(~array.indexOf(n));
			return ~array.indexOf(n);
		});
	}

	function diff(target, array) {
		var result = target.slice();
		for(var i = 0; i < result.length; i++) {
			for(var j = 0; j < array.length; j++) {
				if(result[i] === array[j]) {
					result.splice(i, 1);
					i--;
					break;
				}
			}
		}
		return result;
	}

	function min(target) {
		return Math.min.apply(0, target);
	}

	function max(target) {
		return Math.max.apply(0, target);
	}

	//unshift ie6,ie7 bug修复
	if ([].unshift(1) !== 1) {
		var _unshift = Array.prototype.unshift;
		Array.prototype.unshift = function() {
			_unshift.apply(this, arguments);
			return this.length;
		}
	};

	//splice ie6, ie7, ie8 bug修复 版本1
	if([1, 2, 3].splice(1).length == 0) { //如果是ie6, ie7, ie8,则一个元素也没有删除
		var _splice = Array.prototype.splice;
		Array.prototype.splice = function(a) {
			if(arguments.length === 1) {
				return _splice.call(this, a, this.length);
			} else {
				return _splice.call(this, arguments);
			}
		}
	}

	//splice ie6, ie7, ie8 bug修复 版本2  有问题
	/*Array.prototype.splice = function(x, y) {
		var a = arguments, s = a.length - 2 - y, r = this.slice(x, x + y);
		if(s > 0) {
			for(var i = this.length - 1, j= x + y; i >= j; --i) {
				this[i + s] = this[i];
			}
		} else if(s < 0) {
			for(var i = x + y, j = this.length; i < j; ++i) {
				this[i + s] = this[i];
			}
			this.length += s;
		} 
		for(var i = 2, j = a.length; i < j; ++i) {
			this[i - 2 + x] = a[i];
		}
		return r;
	}*/

	var _slice = Array.prototype.slice;

	Array.prototype.pop = function() {
		return this.splice(this.length - 1, 1)[0];
	}

	Array.prototype.push = function() {
		this.splice.apply(this, [this.length, 0].concat(_slice.call(arguments)));
		return this.length;
	}

	Array.prototype.shift = function() {
		return this.splice(0, 1)[0];
	}

	Array.prototype.unshift = function() {
		this.splice.apply(this, [0, 0].concat(_slice.call(arguments)));
		return this.length;
	}

	</script>
</body>
</html>